name: CI Complète Master

on:
  workflow_dispatch:

# Permissions globales nécessaires pour SonarQube
permissions:
  pull-requests: read
  contents: read

jobs:
  # ------------------------------------------------------------------
  # JOB 1 : LINTING (Pre-commit)
  # Vérifie la propreté du code (espaces, fin de fichiers, syntaxe)
  # ------------------------------------------------------------------
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # N'oubliez pas d'avoir le fichier .pre-commit-config.yaml à la racine !
      - uses: pre-commit/action@v3.0.1

  # ------------------------------------------------------------------
  # JOB 2 : SÉCURITÉ CODE (Snyk)
  # Recherche les vulnérabilités dans le code Python
  # ------------------------------------------------------------------
  snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Snyk Monitor
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --all-projects

      - name: Run Snyk Code Test
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --all-projects --severity-threshold=high --sarif-file-output=snyk-code.sarif --exit-code=0

  # ------------------------------------------------------------------
  # JOB 3 : QUALITÉ CODE (SonarQube)
  # Analyse la qualité globale et la dette technique
  # ------------------------------------------------------------------
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important pour Sonar (historique complet)

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Analyze with SonarQube
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # ------------------------------------------------------------------
  # JOB 4 : DOCKER (Build & Scan)
  # Ne se lance QUE si Lint, Snyk et SonarQube ont réussi
  # ------------------------------------------------------------------
  docker:
    needs: [lint, snyk, sonarqube]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- LINTING DOCKERFILES (Hadolint) ---
      - name: Lint Backend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./src/backend/Dockerfile

      - name: Lint Frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./src/frontend/Dockerfile

      # --- BUILD & SCAN BACKEND ---
      - name: Build Backend Docker image
        run: docker build -t my-back:test ./src/backend

      - name: Scan Backend with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "image"
          image-ref: "my-back:test"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      # --- BUILD & SCAN FRONTEND ---
      - name: Build Frontend Docker image
        run: docker build -t my-front:test ./src/frontend

      - name: Scan Frontend with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "image"
          image-ref: "my-front:test"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

  # ------------------------------------------------------------------
  # JOB 5 : DOCS GITHUB PAGES
  # ------------------------------------------------------------------
    deploy:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[ci]
          git config user.email 41898282+github-actions[ci]@users.noreply.github.com

      - uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - run: pip install mkdocs-material 

      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force

  # ------------------------------------------------------------------
  # JOB 6 : NOTIFICATION FINALE
  # S'affiche uniquement si tout le pipeline est vert
  # ------------------------------------------------------------------
  notification:
    needs: docs
    runs-on: ubuntu-latest
    steps:
      - name: Print Success Message
        run: |
          echo "✅ CI PIPELINE SUCCESSFUL"
          echo "Code checked, Security scanned, Docker images built and safe."
